<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>protobuf快速上手指南 - 艾逗笔</title>
    <meta property="og:title" content="protobuf快速上手指南 - 艾逗笔">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="Google Protocol Buffer( 简称 Protobuf) 是 Google 公司内部的混合语言数据标准。
Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。
[&amp;hellip;] # &amp;hellip;">
      <meta property="og:description" content="Google Protocol Buffer( 简称 Protobuf) 是 Google 公司内部的混合语言数据标准。
Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。
[&amp;hellip;] # &amp;hellip;">
      
    

    
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  
  <body class="posts">
    <header class="masthead">
      <h1><a href="/">艾逗笔</a></h1>

<p class="tagline">有逻辑的脑子万里挑一。</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" hidden/>
  <label id="menu-label" for="menu-check" class="unselectable" hidden>
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/categories/">分类</a></li>
  
  <li><a href="/tags/">标签</a></li>
  
  <li><a href="/works/">作品</a></li>
  
  <li><a href="/about/">关于</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>protobuf快速上手指南</h1>

<h3>
  2017-12-02</h3>
<hr>


      </header>



<h2 id="什么是-protobuf">什么是 protobuf</h2>
<p>Google Protocol Buffer( 简称 Protobuf) 是 Google 公司内部的混合语言数据标准。</p>
<p>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 RPC 数据交换格式。可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。</p>
<h2 id="如何安装-protobuf">如何安装 protobuf</h2>
<ul>
<li>在 github 获取 protobuf 源码，windows 系统可以直接下载 exe 文件：https://github.com/google/protobuf/releases</li>
</ul>
<ul>
<li>macos 和 linux 环境使用源码进行安装的步骤</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 获取源码包</span>
wget https://github.com/google/protobuf/archive/v3.5.0.tar.gz

<span style="color:#75715e"># 解压缩并进入源码目录</span>
tar -zxvf v3.5.0.tar.gz
cd protobuf-3.5.0

<span style="color:#75715e"># 生成configure文件</span>
./autogen.sh

<span style="color:#75715e"># 编译安装</span>
./configure
make
make check
make install
</code></pre></div><blockquote>
<p>在执行<code>./autogen.sh</code>过程中可能会因缺乏 automake 依赖库而报错：<strong><em>autoreconf: failed to run aclocal: No such file or directory</em></strong>，要解决此错误，在 linux 系统可以通过<code>sudo yum install automake</code>或者<code>sudo apt-get install automake</code>安装 automake，在 macos 系统可以通过<code>brew install automake</code>安装 automake。</p>
</blockquote>
<ul>
<li>检测 protobuf 是否已成功安装</li>
</ul>
<p>命令行执行<code>protoc --version</code>。windows 系统需要将 protoc.exe 文件所在的目录添加到环境变量。</p>
<h2 id="如何使用-protobuf">如何使用 protobuf</h2>
<p>protobuf 支持跨语言使用，很多主流的开发语言都有 protobuf 支持库，我们用 golang 来演示如何使用 protobuf 进行数据序列化。</p>
<ul>
<li>在 golang 中安装 protobuf 相关的库</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">get</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">u</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">golang</span><span style="color:#f92672">/</span><span style="color:#a6e22e">protobuf</span><span style="color:#f92672">/</span>{<span style="color:#a6e22e">protoc</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gen</span><span style="color:#f92672">-</span><span style="color:#66d9ef">go</span>,<span style="color:#a6e22e">proto</span>}
</code></pre></div><ul>
<li>编写.proto 文件</li>
</ul>
<p>$GOPATH/src/test/protobuf/pb/user.proto</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-proto" data-lang="proto">syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> pb;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">user</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">int32</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">multi_user</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">repeated</span> user users <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><ul>
<li>基于.proto 文件生成数据操作代码</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-proto" data-lang="proto">protoc <span style="color:#f92672">--</span>go_out<span style="color:#f92672">=.</span> user.proto<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>执行命令完成，在与<code>user.proto</code>文件同级的目录下生成了一个<code>user.pb.go</code>文件</p>
<ul>
<li>数据序列化演示
$GOPATH/src/test/protobuf/main.go</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;log&#34;</span>
    <span style="color:#e6db74">&#34;test/protobuf/pb&#34;</span>

    <span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">user1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">User</span>{
        <span style="color:#a6e22e">Id</span>:   <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Int32</span>(<span style="color:#ae81ff">1</span>),
        <span style="color:#a6e22e">Name</span>: <span style="color:#f92672">*</span><span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;Mike&#34;</span>),
    }

    <span style="color:#a6e22e">user2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">User</span>{
        <span style="color:#a6e22e">Id</span>:   <span style="color:#ae81ff">2</span>,
        <span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;John&#34;</span>,
    }

    <span style="color:#a6e22e">users</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MultiUser</span>{
        <span style="color:#a6e22e">Users</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">User</span>{<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user2</span>},
    }

    <span style="color:#75715e">// 序列化数据
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Marshal data error: &#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    println(<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">Users</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">GetName</span>()) <span style="color:#75715e">// output: Mike
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 对已序列化的数据进行反序列化
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">target</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MultiUser</span>
    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">data</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">target</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#e6db74">&#34;Unmarshal data error: &#34;</span>, <span style="color:#a6e22e">err</span>)
    }
    println(<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">GetUsers</span>()[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">Name</span>) <span style="color:#75715e">// output: John
</span><span style="color:#75715e"></span>
}
</code></pre></div><h2 id="相关扩展">相关扩展</h2>
<p>sublime 插件：Protobuf Syntax Hightlighting</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="http://ginobefunny.com/post/learning_protobuf/">Protocol Buffers 简明教程</a></li>
<li><a href="http://blog.csdn.net/xiexievv/article/details/47396725">linux 下安装 google protobuf（详细）</a></li>
<li><a href="http://www.jianshu.com/p/1a3f1c3031b5">Golang 序列化之 ProtoBuf</a></li>
</ul>



<img src="http://blogcdn.idoustudio.com/idoubi-mp.jpeg" width="320" alt="">



<script src="https://utteranc.es/client.js"
        repo="idoubi/idoubi.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


  <footer>
  
  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© <a href="https://idoubi.cc">艾逗笔</a> 2020 | <a href="https://github.com/idoubi">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

