<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>AES加解密在php接口请求过程中的应用 - 艾逗笔</title>
    <meta property="og:title" content="AES加解密在php接口请求过程中的应用 - 艾逗笔">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="在 php 请求接口的时候，我们经常需要考虑的一个问题就是数据的安全性，因为数据传输过程中很有可能会被用 fillder 这样的抓包工具进行截获。一种比较好的解决方案就是在客户端请求发起之前先对要请求的数据进行加密，服务端 api 接收到请求数据后再对数据进行解密处理，返回结果给客户端的时候也对要返回的数据进行加密，客户端接收到返回数据的时候再解密。因此整个 api 请求过程中数据的安全性有了一定 &amp;hellip;">
      <meta property="og:description" content="在 php 请求接口的时候，我们经常需要考虑的一个问题就是数据的安全性，因为数据传输过程中很有可能会被用 fillder 这样的抓包工具进行截获。一种比较好的解决方案就是在客户端请求发起之前先对要请求的数据进行加密，服务端 api 接收到请求数据后再对数据进行解密处理，返回结果给客户端的时候也对要返回的数据进行加密，客户端接收到返回数据的时候再解密。因此整个 api 请求过程中数据的安全性有了一定 &amp;hellip;">
      
    

    
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  
  <body class="posts">
    <header class="masthead">
      <h1><a href="/">艾逗笔</a></h1>

<p class="tagline">有逻辑的脑子万里挑一。</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" hidden/>
  <label id="menu-label" for="menu-check" class="unselectable" hidden>
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/categories/">分类</a></li>
  
  <li><a href="/tags/">标签</a></li>
  
  <li><a href="/works/">作品</a></li>
  
  <li><a href="/about/">关于</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>AES加解密在php接口请求过程中的应用</h1>

<h3>
  2016-10-25</h3>
<hr>


      </header>



<p>在 php 请求接口的时候，我们经常需要考虑的一个问题就是数据的安全性，因为数据传输过程中很有可能会被用 fillder 这样的抓包工具进行截获。一种比较好的解决方案就是在客户端请求发起之前先对要请求的数据进行加密，服务端 api 接收到请求数据后再对数据进行解密处理，返回结果给客户端的时候也对要返回的数据进行加密，客户端接收到返回数据的时候再解密。因此整个 api 请求过程中数据的安全性有了一定程度的提高。</p>
<p>今天结合一个简单的 demo 给大家分享一下 AES 加解密技术在 php 接口请求中的应用。</p>
<h2 id="aes-加解密基础类">AES 加解密基础类：</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * 加密基础类
</span><span style="color:#e6db74"> */</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Crypt_AES</span>
{
    <span style="color:#66d9ef">protected</span> $_cipher <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rijndael-128&#34;</span>;
    <span style="color:#66d9ef">protected</span> $_mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cbc&#34;</span>;
    <span style="color:#66d9ef">protected</span> $_key;
    <span style="color:#66d9ef">protected</span> $_iv <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
    <span style="color:#66d9ef">protected</span> $_descriptor <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 是否按照PKCS #7 的标准进行填充
</span><span style="color:#e6db74">     * 为否默认将填充“&amp;#92;&amp;#48;”补位
</span><span style="color:#e6db74">     * @var boolean
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $_PKCS7 <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 构造函数，对于密钥key应区分2进制字符串和16进制的。
</span><span style="color:#e6db74">     * 如需兼容PKCS#7标准，应选项设置开启PKCS7，默认关闭
</span><span style="color:#e6db74">     * @param string $key
</span><span style="color:#e6db74">     * @param mixed $iv      向量值
</span><span style="color:#e6db74">     * @param array $options
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($key <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>, $iv <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>, $options <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>)
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!==</span> $key) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setKey</span>($key);
        }

        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!==</span> $iv) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setIv</span>($iv);
        }

        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">!==</span> $options) {
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($options[<span style="color:#e6db74">&#39;chipher&#39;</span>])) {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setCipher</span>($options[<span style="color:#e6db74">&#39;chipher&#39;</span>]);
            }

            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($options[<span style="color:#e6db74">&#39;PKCS7&#39;</span>])) {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isPKCS7Padding</span>($options[<span style="color:#e6db74">&#39;PKCS7&#39;</span>]);
            }

            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($options[<span style="color:#e6db74">&#39;mode&#39;</span>])) {
                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setMode</span>($options[<span style="color:#e6db74">&#39;mode&#39;</span>]);
            }
        }
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * PKCS#7状态查看，传入Boolean值进行设置
</span><span style="color:#e6db74">     * @param  boolean  $flag
</span><span style="color:#e6db74">     * @return boolean
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isPKCS7Padding</span>($flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>)
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">===</span> $flag) {
            <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_PKCS7</span>;
        }
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_PKCS7</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">bool</span>) $flag;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 开启加密算法
</span><span style="color:#e6db74">     * @param  string $algorithm_directory locate the encryption
</span><span style="color:#e6db74">     * @param  string $mode_directory
</span><span style="color:#e6db74">     * @return Crypt_AES
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_openMode</span>($algorithm_directory <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34; , </span><span style="color:#e6db74">$mode_directory</span><span style="color:#e6db74"> = &#34;</span>)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_descriptor</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mcrypt_module_open</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_cipher</span>,
                                                $algorithm_directory,
                                                $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_mode</span>,
                                                $mode_directory);
        <span style="color:#66d9ef">return</span> $this;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getDescriptor</span>()
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">===</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_descriptor</span>) {
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_openMode</span>();
        }
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_descriptor</span>;
    }

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_genericInit</span>()
    {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mcrypt_generic_init</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>(), $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getKey</span>(), $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getIv</span>());
    }

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_genericDeinit</span>()
    {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mcrypt_generic_deinit</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>());
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getMode</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_mode</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setMode</span>($mode)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_mode</span> <span style="color:#f92672">=</span> $mode;
        <span style="color:#66d9ef">return</span> $this;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getCipher</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_cipher</span>;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setCipher</span>($cipher)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_cipher</span> <span style="color:#f92672">=</span> $cipher;
        <span style="color:#66d9ef">return</span> $this;
    }
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 获得key
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getKey</span>()
    {
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_key</span>;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 设置可以
</span><span style="color:#e6db74">     * @param string $key
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setKey</span>($key)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_key</span> <span style="color:#f92672">=</span> $key;
        <span style="color:#66d9ef">return</span> $this;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 获得加密向量块,如果其为null时将追加当前Descriptor的IV大小长度
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getIv</span>()
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">null</span> <span style="color:#f92672">===</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_iv</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">in_array</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_mode</span>, <span style="color:#66d9ef">array</span>( <span style="color:#e6db74">&#34;cbc&#34;</span>, <span style="color:#e6db74">&#34;cfb&#34;</span>, <span style="color:#e6db74">&#34;ofb&#34;</span>, ))) {
            $size <span style="color:#f92672">=</span> <span style="color:#a6e22e">mcrypt_enc_get_iv_size</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>());
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_iv</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_pad</span>(<span style="color:#e6db74">&#34;, 16, &#34;</span><span style="color:#f92672">&amp;</span><span style="color:#75715e">#92;&amp;#48;&#34;);
</span><span style="color:#75715e"></span>        }
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_iv</span>;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 获得向量块
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param  string $iv
</span><span style="color:#e6db74">     * @return Crypt_AES $this
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setIv</span>($iv)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_iv</span> <span style="color:#f92672">=</span> $iv;
        <span style="color:#66d9ef">return</span> $this;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 加密
</span><span style="color:#e6db74">     * @param  string $str 被加密文本
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">encrypt</span>($str){
        $td <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>();
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_genericInit</span>();
        $bin <span style="color:#f92672">=</span> <span style="color:#a6e22e">mcrypt_generic</span>($td, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">padding</span>($str));
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_genericDeinit</span>();

        <span style="color:#66d9ef">return</span> $bin;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">padding</span>($dat)
    {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isPKCS7Padding</span>()) {
            $block <span style="color:#f92672">=</span> <span style="color:#a6e22e">mcrypt_enc_get_block_size</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>());

            $len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($dat);
            $padding <span style="color:#f92672">=</span> $block <span style="color:#f92672">-</span> ($len <span style="color:#f92672">%</span> $block);
            $dat <span style="color:#f92672">.=</span> <span style="color:#a6e22e">str_repeat</span>(<span style="color:#a6e22e">chr</span>($padding),$padding);
        }

        <span style="color:#66d9ef">return</span> $dat;
    }

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unpadding</span>($str)
    {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isPKCS7Padding</span>()) {
            $pad <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>($str[($len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($str)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]);
            $str <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($str, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">strlen</span>($str) <span style="color:#f92672">-</span> $pad);
        }
        <span style="color:#66d9ef">return</span> $str;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 解密
</span><span style="color:#e6db74">     * @param  string $str
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">decrypt</span>($str){
        $td <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDescriptor</span>();

        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_genericInit</span>();
        $text <span style="color:#f92672">=</span> <span style="color:#a6e22e">mdecrypt_generic</span>($td, $str);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">_genericDeinit</span>();

        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">unpadding</span>($text);
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 16进制转成2进制数据
</span><span style="color:#e6db74">     * @param  string $hexdata 16进制字符串
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">hex2bin</span>($hexdata)
    {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pack</span>(<span style="color:#e6db74">&#34;H*&#34;</span> , $hexdata);
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 字符串转十六进制
</span><span style="color:#e6db74">     * @param  string $hexdata 16进制字符串
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">strToHex</span>($string)
    {
        $hex<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
        <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($string);$i<span style="color:#f92672">++</span>)
            $hex<span style="color:#f92672">.=</span><span style="color:#a6e22e">dechex</span>(<span style="color:#a6e22e">ord</span>($string[$i]));
        $hex<span style="color:#f92672">=</span><span style="color:#a6e22e">strtoupper</span>($hex);
        <span style="color:#66d9ef">return</span> $hex;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * 十六进制转字符串
</span><span style="color:#e6db74">     * @param  string $hexdata 16进制字符串
</span><span style="color:#e6db74">     * @return string
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">hexToStr</span>($hex)
    {
        $string<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
        <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">strlen</span>($hex)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;$i<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>)
            $string<span style="color:#f92672">.=</span><span style="color:#a6e22e">chr</span>(<span style="color:#a6e22e">hexdec</span>($hex[$i]<span style="color:#f92672">.</span>$hex[$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]));
        <span style="color:#66d9ef">return</span>  $string;
    }
}
</code></pre></div><h2 id="客户端请求部分">客户端请求部分：</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;AES.php&#39;</span>;

$md5Key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ThisIsAMd5Key&#39;</span>;                              <span style="color:#75715e">// 对应服务端：$md5key = &#39;ThisIsAMd5Key&#39;;
</span><span style="color:#75715e"></span>$aesKey <span style="color:#f92672">=</span> <span style="color:#a6e22e">Crypt_AES</span><span style="color:#f92672">::</span><span style="color:#a6e22e">strToHex</span>(<span style="color:#e6db74">&#39;1qa2ws4rf3edzxcv&#39;</span>);      <span style="color:#75715e">// 对应服务端：$aesKey = &#39;3171613277733472663365647A786376&#39;;
</span><span style="color:#75715e"></span>$aesKey <span style="color:#f92672">=</span> <span style="color:#a6e22e">Crypt_AES</span><span style="color:#f92672">::</span><span style="color:#a6e22e">hex2bin</span>($aesKey);
$aesIV  <span style="color:#f92672">=</span> <span style="color:#a6e22e">Crypt_AES</span><span style="color:#f92672">::</span><span style="color:#a6e22e">strToHex</span>(<span style="color:#e6db74">&#39;dfg452ws&#39;</span>);              <span style="color:#75715e">// 对应服务端：$aesIV = &#39;6466673435327773&#39;;
</span><span style="color:#75715e"></span>$aes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Crypt_AES</span>($aesKey,$aesIV,<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;PKCS7&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#66d9ef">true</span>, <span style="color:#e6db74">&#39;mode&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#39;cbc&#39;</span>));

<span style="color:#75715e">// var_dump($aes);
</span><span style="color:#75715e"></span>
$data[<span style="color:#e6db74">&#39;name&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;idoubi&#39;</span>;
$data[<span style="color:#e6db74">&#39;sex&#39;</span>]<span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;male&#39;</span>;
$data[<span style="color:#e6db74">&#39;age&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span>;
$data[<span style="color:#e6db74">&#39;signature&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;白天我是一个程序员，晚上我就是一个有梦想的演员。&#39;</span>;

$content <span style="color:#f92672">=</span> <span style="color:#a6e22e">base64_encode</span>($aes<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">encrypt</span>(<span style="color:#a6e22e">json_encode</span>($data)));
$content <span style="color:#f92672">=</span> <span style="color:#a6e22e">urlencode</span>($content);
$sign <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($content<span style="color:#f92672">.</span>$md5Key);

$url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost/aesdemo/api.php&#39;</span>;
$params <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;version=1.0&amp;sign=</span><span style="color:#e6db74">$sign</span><span style="color:#e6db74">&amp;content=</span><span style="color:#e6db74">$content</span><span style="color:#e6db74">&#34;</span>;

<span style="color:#75715e">// 请求接口
</span><span style="color:#75715e"></span><span style="color:#a6e22e">post</span>($url, $params);

<span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * 接口请求函数
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">post</span>($url, $params) {
    $curlPost<span style="color:#f92672">=</span> $params;
    $ch <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_init</span>();      <span style="color:#75715e">//初始化curl
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_URL</span>, $url);    <span style="color:#75715e">//提交到指定网页
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_HEADER</span>, <span style="color:#ae81ff">0</span>);    <span style="color:#75715e">//设置header
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_RETURNTRANSFER</span>, <span style="color:#ae81ff">1</span>);   <span style="color:#75715e">//要求结果为字符串且输出到屏幕上
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_POST</span>, <span style="color:#ae81ff">1</span>);    <span style="color:#75715e">//post提交方式
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_setopt</span>($ch, <span style="color:#a6e22e">CURLOPT_POSTFIELDS</span>, $curlPost);
    $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_exec</span>($ch);<span style="color:#75715e">//运行curl
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curl_close</span>($ch);
    <span style="color:#a6e22e">var_dump</span>(<span style="color:#a6e22e">json_decode</span>($result, <span style="color:#66d9ef">true</span>));
}
</code></pre></div><h2 id="接口处理逻辑">接口处理逻辑：</h2>
<pre><code>&lt;?php

include 'AES.php';

$data = $_POST;  // 接口请求得到的数据
$content = $data['content'];
$sign = $data['sign'];

$aesKey = '3171613277733472663365647A786376';
$aesIV = '6466673435327773';
$md5key = 'ThisIsAMd5Key';

// 校验数据
if(strcasecmp(md5(urlencode($content).$md5key),$sign) == 0) {
    // 数据校验成功
    $key = Crypt_AES::hex2bin($aesKey);
    $aes = new Crypt_AES($key, $aesIV, array('PKCS7'=&gt;true, 'mode'=&gt;'cbc'));

    $decrypt = $aes-&gt;decrypt(base64_decode($content));
    if (!$decrypt) {      // 解密失败
        echo json_encode('can not decrypt the data');
    } else {
        echo json_encode($decrypt);     // 解密成功
    }
} else{
    echo json_encode('data is not integrity');       // 数据校验失败
}

</code></pre><p>上述接口请求过程中定义了三个加解密需要用到的参数：$aesKey、$aesIV、$md5key，在实际应用过程中，只要与客户端用户约定好这三个参数，客户端程序员利用这几个参数对要请求的数据进行加密后再请求接口，服务端程序员在接收到数据后利用同样的加解密参数对数据进行解密，整个 api 请求过程中的数据就很安全了。</p>
<p><a href="http://ov13triio.bkt.clouddn.com/2016/10/aesdemo.zip">aesdemo</a></p>



<img src="http://blogcdn.idoustudio.com/idoubi-mp.jpeg" width="320" alt="">



<script src="https://utteranc.es/client.js"
        repo="idoubi/idoubi.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


  <footer>
  
  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© <a href="https://idoubi.cc">艾逗笔</a> 2020 | <a href="https://github.com/idoubi">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

